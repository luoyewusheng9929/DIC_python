import numpy as np

import CpCorr as cp
import cv2
grid_x = [
    1010.75000000000,
    1010.75000000000,
    1010.75000000000,
    1010.75000000000,
    1010.75000000000,
    1020.75000000000,
    1020.75000000000,
    1020.75000000000,
    1020.75000000000,
    1020.75000000000,
    1030.75000000000,
    1030.75000000000,
    1030.75000000000,
    1030.75000000000,
    1030.75000000000,
    1040.75000000000,
    1040.75000000000,
    1040.75000000000,
    1040.75000000000,
    1040.75000000000,
]
grid_y = [
    362.500000000000,
    372.500000000000,
    382.500000000000,
    392.500000000000,
    402.500000000000,
    362.500000000000,
    372.500000000000,
    382.500000000000,
    392.500000000000,
    402.500000000000,
    362.500000000000,
    372.500000000000,
    382.500000000000,
    392.500000000000,
    402.500000000000,
    362.500000000000,
    372.500000000000,
    382.500000000000,
    392.500000000000,
    402.500000000000,
]
valid_x = [
    1010.75000000000,
    1010.75000000000,
    1010.75000000000,
    1010.75000000000,
    1010.75000000000,
    1020.75000000000,
    1020.89796804432,
    1021.04402662072,
    1021.17425038579,
    1021.33842828290,
    1030.75000000000,
    1031.05433822791,
    1031.21171473833,
    1031.33207782109,
    1031.48073217087,
    1040.75000000000,
    1041.25218940012,
    1041.41745609376,
    1041.53654727447,
    1040.64265698990,
]
valid_y = [
    362.500000000000,
    372.500000000000,
    382.500000000000,
    392.500000000000,
    402.500000000000,
    362.500000000000,
    372.551727129147,
    382.608297991371,
    392.669756648156,
    402.767800630505,
    362.500000000000,
    372.604895411877,
    382.664072474158,
    392.713849873657,
    402.813946883562,
    362.500000000000,
    372.657759688826,
    382.724958292074,
    392.752734593435,
    402.828435572044,
]
valid_xy = np.column_stack((valid_x, valid_y))
grid_xy = np.column_stack((grid_x, grid_y))
y_max = 5
x_max = 4
# 打开视频文件
cap = cv2.VideoCapture('D:\\project\\pycharm\\DIC\\UCC\\UCC_mp\\cx\\MVI_1681_0-1.MOV')

# 读取第一帧
ret1, original = cap.read()

# 读取第二帧
ret2, deformed = cap.read()

# 关闭视频文件
cap.release()
red_channel = original[:,:,2]
# 检查 original 的维度是否大于 2
if len(original.shape) > 2:
    # 转换为灰度图像
    original = cv2.cvtColor(original, cv2.COLOR_BGR2GRAY)
    deformed = cv2.cvtColor(deformed, cv2.COLOR_BGR2GRAY)
input_correl = cp.cpcorr(valid_xy, grid_xy, deformed, original)
input_correl_x = input_correl[:, 0]
input_correl_y = input_correl[:, 1]
uq = np.reshape(input_correl_x - grid_x, (y_max, x_max))
vq = np.reshape(input_correl_y - grid_y, (y_max, x_max))
dx = []
dy = []
uq_nonzero = uq[uq != 0]
vq_nonzero = vq[vq != 0]
dx.append(np.mean(uq_nonzero))
dy.append(np.mean(vq_nonzero))
print()
print('dx:', dx)
print('dy:', dy)